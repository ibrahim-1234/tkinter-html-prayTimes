<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pray Times</title>

    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: black;
            color: aliceblue;
            font-size: 26px;
            font-family: Arial, Helvetica, sans-serif;
            row-gap: 20px;
        }

        .container {
            display: flex;
            column-gap: 20px;
        }

        .date-container {
            font-size: 32px;
        }

        #pray {
            display: flex;
            flex-direction: column;
            row-gap: 8px;
        }

        #prayName {
            display: flex;
            flex-direction: column;
            row-gap: 40px;
        }

        .time {
            color: tomato;
        }

        .time-remain {
            color: lime;
        }
    </style>
</head>

<body dir="rtl">

    <div class="date-container">
        <span class="date"></span>
    </div>

    <div class="container">
        <div id="prayName">
            <span>الفجر</span>
            <span>الشروق</span>
            <span>الظهر</span>
            <span>العصر</span>
            <span>المغرب</span>
            <span>العشاء</span>
        </div>
        <div id="pray"></div>
    </div>

    <script>
        /* ------------------ LOCATION ------------------ */
        async function getLocation() {
            let cached = localStorage.getItem('countryCity');
            if (cached) return cached.split(',');

            const res = await fetch('https://ipinfo.io/json/');
            const data = await res.json();
            localStorage.setItem('countryCity', `${data.city},${data.country_name}`);
            return [data.city, data.country_name];
        }

        /* ------------------ PRAYER TIMES ------------------ */
        async function getTimes() {
            const cached = localStorage.getItem('prayerTimes');
            const today = new Date().toDateString();

            if (cached) {
                const { data, date } = JSON.parse(cached);
                if (date === today) return data;
            }

            const [city, country] = await getLocation();
            const url = `https://api.aladhan.com/v1/timingsByCity?city=${city}&country=${country}&method=4`;
            const res = await fetch(url);
            const json = await res.json();

            const remove = ['Sunset', 'Imsak', 'Midnight', 'Firstthird', 'Lastthird'];
            const timings = json.data.timings;
            remove.forEach(k => delete timings[k]);

            localStorage.setItem('prayerTimes', JSON.stringify({
                data: timings,
                date: today
            }));

            return timings;
        }

        /* ------------------ TIME HELPERS ------------------ */
        function pad(n) { return n < 10 ? '0' + n : n; }

        function format(ms) {
            const s = Math.floor(ms / 1000);
            const h = pad(Math.floor(s / 3600));
            const m = pad(Math.floor((s % 3600) / 60));
            const sec = pad(s % 60);
            return `${h}:${m}:${sec}`;
        }

        /* ------------------ UI UPDATE ------------------ */
        function render(data) {
            const now = new Date();
            const container = document.getElementById('pray');
            container.innerHTML = '';

            Object.entries(data).forEach(([name, time]) => {
                const [h, m] = time.split(':').map(Number);
                const target = new Date();
                target.setHours(h, m, 0, 0);

                let diff = target - now;
                let span = document.createElement('span');

                if (diff <= 0) {
                    span.innerHTML = `${time} <br> <span class="time">${format(-diff)} - انتهت</span>`;
                } else {
                    span.innerHTML = `${time} <br> <span class="time-remain">${format(diff)} - باقي</span>`;
                }

                container.appendChild(span);
            });
        }

        /* ------------------ CLOCK (NO DRIFT) ------------------ */
        function startClock(data) {
            let lastSecond = -1;

            function tick() {
                const now = new Date();
                if (now.getSeconds() !== lastSecond) {
                    lastSecond = now.getSeconds();
                    render(data);
                }
                requestAnimationFrame(tick);
            }
            tick();
        }

        /* ------------------ MAIN ------------------ */
        async function main() {
            const hijri = new Intl.DateTimeFormat('ar-SA', { calendar: 'islamic-umalqura',  timeZone: 'Asia/Riyadh' }).format(new Date());
            document.querySelector('.date').textContent = hijri;

            const data = await getTimes();
            startClock(data);
        }

        main();
    </script>

</body>

</html>

